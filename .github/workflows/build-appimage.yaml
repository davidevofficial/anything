name: Build AppImage (Rust egui)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in Ubuntu 20.04 container
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            ubuntu:20.04 \
            bash -lc '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              # toolchain + deps
              apt-get install -y \
                build-essential pkg-config curl git \
                ca-certificates \
                desktop-file-utils zsync \
                fuse libfuse2 wget

              # install Rust
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"


              # build your egui app
              cargo build --release

              # create AppDir layout
              APPDIR=AppDir
              mkdir -p "$APPDIR/usr/bin"
              mkdir -p "$APPDIR/usr/share/applications"
              mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"

              # copy binary (change "Anything" to your crate name)
              cp target/release/Anything "$APPDIR/usr/bin/Anything"

              # desktop file (edit Name, Exec, Icon, Categories, etc.)
              cat > "$APPDIR/usr/share/applications/Anything.desktop" <<EOF
              [Desktop Entry]
              Type=Application
              Name=Anything
              Exec=Anything
              Icon=Anything
              Categories=Utility;
              EOF
              echo 1
              # icon (provide your own PNG/SVG)
              # Example assumes you have assets/icon.png in repo
              cp settings/icon.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/Anything.png"

              # top-level AppRun (simple launcher)
              cat > "$APPDIR/AppRun" <<EOF
              #!/bin/sh
              HERE="$(dirname "$(readlink -f "$0")")"
              exec "$HERE/usr/bin/Anything" "$@"
              EOF
              echo 2
              chmod +x "$APPDIR/AppRun"


              # top-level icon + desktop for AppImage metadata
              cp "$APPDIR/usr/share/icons/hicolor/256x256/apps/Anything.png" "$APPDIR/Anything.png"
              cp "$APPDIR/usr/share/applications/Anything.desktop" "$APPDIR/Anything.desktop"

              # download appimagetool
              wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
              chmod +x appimagetool-x86_64.AppImage

              # build AppImage
              ./appimagetool-x86_64.AppImage "$APPDIR" Anything-x86_64.AppImage
              echo "$APPDIR"
              # Verify and show files at repo root
              ls -lah
              if [ ! -f Anything-x86_64.AppImage ]; then
                echo "AppImage not created in /workspace"
                exit 1
              fi
            '

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Anything
          path: Anything-x86_64.AppImage
