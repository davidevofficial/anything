name: Build AppImage (Rust egui)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in Ubuntu 20.04 container
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            ubuntu:20.04 \
            bash -lc '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              # toolchain + deps
              apt-get install -y \
                build-essential pkg-config curl git \
                ca-certificates \
                desktop-file-utils zsync \
                fuse libfuse2 wget

              # build your egui app
              APPIMAGE_EXTRACT_AND_RUN=1 cargo appimage
              APPIMAGE_PATH="$(find target -maxdepth 3 -type f -name '*.AppImage' | head -n 1)"
              mv "$APPIMAGE_PATH" Anything-x86_64.AppImage
            '

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Anything
          path: Anything-x86_64.AppImage
