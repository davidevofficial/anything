name: Build AppImage (Rust egui)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in Ubuntu 20.04 container
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            ubuntu:20.04 \
            bash -lc '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              # toolchain + deps
              apt-get install -y \
                build-essential pkg-config curl git \
                ca-certificates \
                desktop-file-utils zsync \
                fuse libfuse2 wget

              # install Rust
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"

              modprobe fuse
              # install cargo-appimage
              cargo install cargo-appimage

              # download appimagetool (needed by cargo-appimage)
              wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
              chmod +x appimagetool-x86_64.AppImage
              mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

              apt-get install libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev -y libxkbcommon-dev libssl-dev
              apt-get install libatk1.0-dev libgdk-pixbuf2.0-dev -y
              apt-get install libgtk-3-dev -y
              # build AppImage with cargo-appimage
              # (assumes your main binary is the default crate binary)
              cargo appimage

              # cargo-appimage by default produces something like target/appimage/<name>.AppImage
              # Rename to Anything.AppImage; adjust path if your layout differs
              APPIMAGE_PATH="$(find target -maxdepth 3 -type f -name '*.AppImage' | head -n 1)"
              mv "$APPIMAGE_PATH" Anything.AppImage
            '

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Anything
          path: Anything.AppImage
